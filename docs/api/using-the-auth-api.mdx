---
title: 'Using the Auth API'
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

Two `POST` requests are needed to authenticate a user:
* First call `/auth/start` to start the authentication process
* Then every two seconds call `/auth/poll` to check whether the user has authenticated

The `/auth/start` request returns a json object that needs to be used for the second post request to `/auth/poll`

### Example request to authenticate a person

```json
## Request for authentication via e-sim

POST /api/auth HTTP/1.1
Host: onboardingdev.taktikal.is
Accept: application/json
Content-Type: application/json
{
  "PhoneNumber": "8433600",
  "FlowKey": "54ab65385c5b",
  "AuthenticationContextType": "Sim"
}

## Request for authentication via app

POST /api/auth/start HTTP/1.1
Host: onboardingdev.taktikal.is
Accept: application/json
Content-Type: application/json
{
  "Ssn": "1234567890",
  "FlowKey": "54ab65385c5b",
  "AuthenticationContextType": "App"
}

## Response
{
  "authRequestId": "1-147rag342352345",
  "verificationCode": "1234"
}
```

The response will include the `verifcationCode` which the user will see in their device and we strongly recommend to display on your end. And `authRequestId` which you will need to send every two seconds to `/auth/poll` until user logs in or request times out (180 seconds).

The `/auth/poll` request returns a `Customer` object but with different amount of
information filled out depending on the `LookupType`. If
`LookupType.NameAddressFamily` is selected then the extra values returned will
be returned in `Meta`

There are three different return types depending on the `LookupType`

1. `Name`: Will only return the SSN and Name of the authenticated person. This
   has no additional lookup cost.
2. `NameAddress`: Will return Name, SSN and legal address information. This has
   an additional lookup cost. This is the default value if no value is given for
   `LookupType`.
3. `NameAddressFamily`: Returns Name, SSN, Address data, gender code, and family
   information. _Note: Family lookup requires special permission_.


### Example request to poll authentication status of user

```json
## Request for polling

POST /api/auth/poll HTTP/1.1
Host: onboardingdev.taktikal.is
Accept: application/json
Content-Type: application/json
{
  "PhoneNumber": "8433600",
  "FlowKey": "54ab65385c5b",
  "AuthenticationContextType": "Sim"
}


POST /api/auth HTTP/1.1
Host: onboardingdev.taktikal.is
Accept: application/json
Content-Type: application/json
{
  "authRequestId": "1-147rag342352345",
  "FlowKey": "54ab65385c5b",
  "LookupType": "NameAddressFamily"
}

## Response
{
  "waitingForUserInput": false, //true if still waiting for user to authenticate
  "statusMessage": "ok",
  "customer": {
      "name": "Test User",
      "ssn": "1234567890",
      "phoneNumber": "8433600",
      "address": "Address 5",
      "postalCode": "555",
      "city": "Reykjavík",
      "token": "f19b032a237e4fbc94f3",
      "flowKey": "98ab35315c5b",
      "meta": {
          "ParnerSsn": "1231231245",
          "FamilyNumber": "1234567890",
          "GenderCode": "1",
          "FamilyStatus": "3"
      }
  }
}
```

### Examples code in different languages

<Tabs
  defaultValue="nodejs"
  values={[
    { label: 'Node.js', value: 'nodejs' },
    { label: 'C#', value: 'csharp' },
    { label: 'PHP', value: 'php' }
  ]}
>

<TabItem value="nodejs">

```ts
const request = require("request");

const start = {
  method: 'POST',
  url: 'https://onboardingdev.taktikal.is/api/auth/start',
  headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
  body: {
    PhoneNumber: '8433600',
    FlowKey: '54ab65385c5b',
    AuthenticationContextType: 'Sim'
  },
  json: true
};

request(start, async function (error, response, body) {
  if (error) throw new Error(error);

  const poll = {
    method: 'POST',
    url: 'https://onboardingdev.taktikal.is/api/auth/poll',
    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
    body: {
      authRequestId: body.authRequestId,
      LookupType: 'Name'
    },
    json: true
  };

  while (true) {
    await new Promise(r => setTimeout(r, 2000));

    request(poll, function (error, response, body) {
      if (error) throw new Error(error);

      if (!body.waitingForUserInput) {
        console.log(body.customer);
        process.exit(0);
      }
    });
  }
});
```

</TabItem>
<TabItem value="csharp">

```csharp
var httpClient = new System.Net.Http.HttpClient();
var resp = await httpClient.PostAsJsonAsync("https://onboardingdev.taktikal.is/api/auth/start", new
{
    FlowKey = "54ab65385c5b",
    PhoneNumber = "8433600",
    AuthenticationContextType = AuthenticationContextType.Sim // or just "Sim" if you don't want to use an enum
});

var startAuthResponse = await resp.Content.ReadFromJsonAsync<StartAuthResponse>();
while (true)
{
    await Task.Delay(2000);
    var pollResponse = await httpClient.PostAsJsonAsync("https://onboardingdev.taktikal.is/api/auth/poll", new
    {
        FlowKey = "54ab65385c5b",
        AuthRequestId = startAuthResponse.AuthRequestId,
        LookupType = LookupType.NameAddressFamily // or just "NameAddressFamily" if you don't want to use an enum
    });

    if (pollResponse.IsErrorResponse())
    {
        // log error
        break;
    }

    var parsedResponse = await pollResponse.Content.ReadFromJsonAsync<PollCustomer>();
    if (!parsedResponse.WaitingForUserInput)
    {
        // access customer object here parsedResponse.Customer
        break;
    }
}
```

</TabItem>
<TabItem value="php">

```php
<?php

$request = new HttpRequest();
$request->setUrl('https://onboardingdev.taktikal.is/api/auth/start');
$request->setMethod(HTTP_METH_POST);

$request->setHeaders(array(
  'Host' => 'onboardingdev.taktikal.is',
  'Content-Type' => 'application/json',
  'Accept' => 'application/json'
));

$request->setBody('{
  "PhoneNumber": "8433600",
  "FlowKey": "54ab65385c5b",
  "AuthenticationContextType": "Sim"
}');

try {
  $response = $request->send();
  $startAuthResponse = $response->getBody();
  while(true) {
    sleep(2)
    $request->setBody('{
        "AuthRequestId": startAuthResponse.authRequestId,
        "FlowKey": "54ab65385c5b",
        "LookupType": "NameAddressFamily"
    }');
    $response = $request->send();
    $pollResponse = $response->getBody();
    if(!$pollResponse.waitingForUserInput) {
        echo $pollResponse
        break;
    }
  }
} catch (HttpException $ex) {
  echo $ex;
}
```

</TabItem>
</Tabs>

## Errors

The endpoint `/auth/poll` will return a 403 response if user is not authenticated and we are no longer waiting for him and the body will contain the reason why

## Old method

### Example request to authenticate a person

```json
## Request

POST /api/auth HTTP/1.1
Host: onboardingdev.taktikal.is
Accept: application/json
Content-Type: application/json
{
  "PhoneNumber": "8433600",
  "FlowKey": "54ab65385c5b",
  "LookupType": "NameAddressFamily"
}

## Response
{
    "name": "Test User",
    "ssn": "1234567890",
    "phoneNumber": "8433600",
    "address": "Address 5",
    "postalCode": "555",
    "city": "Reykjavík",
    "token": "f19b032a237e4fbc94f3",
    "flowKey": "98ab35315c5b",
    "meta": {
        "ParnerSsn": "1231231245",
        "FamilyNumber": "1234567890",
        "GenderCode": "1",
        "FamilyStatus": "3"
    }
}
```
